# 04 아키텍처
## 4.1 MySQL 엔진 아키텍처
### 4.1.1 MySQL의 전체 구조
- 구성
  - MySQL 엔진 (두뇌 역할) + 스토리지 엔진 (손발 역할)
- MySQL 엔진
  - 클라이언트 접속 및 쿼리 요청 처리하는 커넥션 핸들러
  - SQL파서 및 전처리기
  - 쿼리 최적화된 실행을 위한 옵티마이저
  - 표준 SQL(ANSI SQL) 문법 지원
- 스토리지 엔진 : 
  - 디스크 스토리지 저장
  - 디스트 스토리지로부터 데이터 읽어옴 
- 4.1.1.3 핸들러 API
  - MySQL 엔진 <> 스토리지 엔진 간 데이터를 쓰기, 읽기 요청할 때 사용되는 API
### 4.1.2 MySQL 쓰레딩 구조
- 스레드 기반으로 작동하며, 포그라운드(Foreground)스레드와 백그라운드(Background)스레드로 구분한다.
- 포그라운드 스레드(클라이언트 스레드)
  - MySQL 서버에 접속된 클라이언트 수만큼 존재
  - 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리
  - 사용자가 작업 마치고 커넥션을 종료하면 해당 커넥션을 담당하던 스레드는 다시 스레드 캐시(Thread cache)로 되돌아 감.
    - 스레드 캐시가 일정 개수 이상이면 캐기가 아닌 스레드 종료시킴
    - 스레드 캐시 유지 가능한 설정 시스템 변수 : ```thread_cache_size```
  - 데이터를 버퍼나 캐시에서 가져오는데, 버퍼/캐시에 없는 경우 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와 작업처리
    - MyISAM 테이블은 버퍼/캐시~디스크까지 담당
    - InnoDB 테이블은 버퍼/캐시만 포그라운드, 디스크 기록은 백그라운드가 처리
- 백그래운드 스레드(InnoDB에만 해당)
  - 역할
    - 로그를 디스크로 기록하는 스레드
    - InnoD 버퍼 풀의 데이터를 디스크에 기록하는 스레드
  - 쓰기 작업은 지연되도, 읽기작업은 지연되면 안되기 때문에 버퍼링으로 일괄 처리하는 기능이 탑재되어있음
    - MyISAM은 버퍼링 기능 X
### 4.1.3 메모리 할당 및 사용 구조
- 글로벌 메모리 영역
  - 클라이언트 스레드 수와 무관
  - 글로벌 영역이 N개여도 모든 스레드 영역에 의해 공유됨
  - 종류
    - 테이블 캐시
    - InnoDB 버퍼 풀
    - InnoDB 어댑티브 해시 인덱스
    - InnoDB 리두 로그 버퍼
- 로컬 메모리 영역 (=세션 메모리 영역)
  - 클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역
  - 스레드별로 절대 공유되면 안됨
  - 쿼리 용도별로 필요할 때만 공간 할당되고, 필요하지 않을 경우 메모리 공간을 할당조차 안할 수 있음.
  - 종류
    - 정렬버퍼
    - 조인버퍼
    - 바이너리 로그 캐시
    - 네트워크 버퍼
### 4.1.4 플러그인 스토리지 엔진 모델
- 하나의 쿼리 작업은 여러 하위 작업으로 나뉘는데, 각 하위작업이 MySQL 엔진 영역인지, 스토리지 엔진 영역에서 처리되는지 구분할 수 있어야한다.
### 4.1.5 컴포넌트
- 플러그인의 단점을 보완하기 위해 구현
  - 플러그인은 오직 MySQL서버와 인터페이스 할 수 있고, 플러그인끼리는 통신할 수 없음.
  - MySQL서버의 변수나 함수를 직접 호출하기 때문에 안전하지 않음(캡슐화 X)
  - 상호 의존 관계를 설정할 수 없어 초기화가 어려움.
- 
### 4.1.9 스레드 풀
- 동시 처리되는 요청이 많더라도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 서버 자원 소모 줄이는 것이 목적
- Percona server
  - CPU 코어 개수만큼 스레드 그룹 생성
  - ```thread_pool_size``` 시스템 변수 변경해서 조정
  - 스레드 그룹의 모든 스레드가 일하고 있는 경우 새로운 작업 스레드 (worker thread) or 기다리는지 판단 필요
  - ``` thread_pool_stall_limit ``` : 직금 처리 중인 작업을 끝내지 못하면 새로운 스레드 생성
  - ``` thread_pool_max_threads``` : 전체 스레드 풀의 개수는 이 설정을 넘을 수 없음.
### 4.1.10 트랜잭션 지원 메타데이터
- 테이블 구조정보, 스토어드 프로그램 -> 데이터 딕셔너리 or 메타데이터
- MySQL 8.0 부터는 테이블 구조정보와 스토어드 프로그램 관련 정보를 모두 innoDB 테이블에 저장
  - mysql.ibd 이름의 테이블 스페이스에 저장 => 매우 중요!!!!